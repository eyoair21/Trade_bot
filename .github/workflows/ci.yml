name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: poetry install

      - name: Run ruff
        run: poetry run ruff check .

      - name: Run black
        run: poetry run black --check .

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: poetry install

      - name: Run mypy
        run: poetry run mypy traderbot

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: poetry install

      - name: Run tests with coverage
        run: |
          poetry run pytest --cov=traderbot --cov-report=term-missing --cov-report=xml --cov-fail-under=70 -q

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  verify-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: poetry install

      - name: Verify CLI help works
        run: poetry run python -m traderbot.cli.walkforward --help

      - name: Generate sample data
        run: poetry run python scripts/make_sample_data.py --synthetic-only

      - name: Run demo walk-forward
        run: |
          poetry run python -m traderbot.cli.walkforward \
            --start-date 2023-01-10 \
            --end-date 2023-03-31 \
            --universe AAPL MSFT NVDA \
            --n-splits 3 \
            --is-ratio 0.6

      - name: Verify output files created
        run: |
          # Find the most recent run directory
          RUN_DIR=$(ls -td runs/*/ | head -1)
          echo "Run directory: $RUN_DIR"

          # Check for required files
          test -f "${RUN_DIR}results.json" && echo "results.json exists"
          test -f "${RUN_DIR}equity_curve.csv" && echo "equity_curve.csv exists"
          test -f "${RUN_DIR}run_manifest.json" && echo "run_manifest.json exists"

  all-checks:
    needs: [lint, type-check, test, verify-cli]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: echo "All CI checks passed successfully!"
